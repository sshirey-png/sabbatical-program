<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Sabbatical | FirstLine Schools</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Open Sans', 'system-ui', '-apple-system', 'sans-serif'],
                    },
                    colors: {
                        'fls-orange': '#e47727',
                        'fls-orange-dark': '#c9621c',
                        'fls-navy': '#002f60',
                        'fls-blue': '#094aad',
                        'fls-light-blue': '#e8f4f8',
                    },
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Open Sans', system-ui, -apple-system, sans-serif; }
        .status-applied { background-color: #fef3c7; color: #92400e; }
        .status-approved { background-color: #dbeafe; color: #1e40af; }
        .status-planning { background-color: #e0e7ff; color: #3730a3; }
        .status-confirmed { background-color: #dcfce7; color: #166534; }
        .status-on-sabbatical { background-color: #d1fae5; color: #065f46; }
        .status-returning { background-color: #fef3c7; color: #92400e; }
        .status-completed { background-color: #f3f4f6; color: #374151; }
        .loader {
            border: 3px solid #e2e8f0;
            border-top: 3px solid #e47727;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .fade-in { animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .tab-active { border-bottom: 3px solid #e47727; color: #002f60; font-weight: 600; }
        .tab-inactive { border-bottom: 3px solid transparent; color: #6b7280; }
        .tab-inactive:hover { color: #002f60; }
        .checklist-phase { cursor: pointer; }
        .checklist-phase:hover { background-color: #f9fafb; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="sticky top-0 z-50 bg-fls-navy border-b border-fls-navy">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center gap-4">
                    <a href="/">
                        <img src="https://firstlineschools.org/wp-content/uploads/2020/08/FLS-Logo_v2019_Color.png" alt="FirstLine Schools" class="h-10 bg-white rounded px-2 py-1">
                    </a>
                    <div>
                        <h1 class="text-lg font-semibold text-white">My Sabbatical</h1>
                        <p class="text-xs text-orange-200">Planning & Progress</p>
                    </div>
                </div>
                <div id="authSection" class="flex items-center gap-3">
                    <div id="userInfo" class="flex items-center gap-3">
                        <span id="userName" class="text-sm text-white hidden sm:inline"></span>
                        <a href="/?admin=true" id="backToAdminLink" class="hidden inline-flex items-center gap-2 px-4 py-2 text-sm font-medium bg-white text-fls-navy hover:bg-gray-100 rounded-lg transition-colors">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                            </svg>
                            <span class="hidden sm:inline">Back to Admin</span>
                        </a>
                        <a href="/approvals" id="approvalsLink" class="hidden inline-flex items-center gap-2 px-4 py-2 text-sm font-medium bg-fls-orange hover:bg-orange-600 text-white rounded-lg transition-colors">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <span class="hidden sm:inline">Approvals</span>
                        </a>
                        <a href="/logout" class="inline-flex items-center gap-2 px-4 py-2 text-sm font-medium text-white hover:bg-fls-blue rounded-lg transition-colors">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                            </svg>
                            <span class="hidden sm:inline">Sign Out</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <!-- Loading State -->
        <div id="loadingState" class="flex items-center justify-center py-20">
            <div class="loader"></div>
            <span class="ml-3 text-gray-600">Loading your sabbatical...</span>
        </div>

        <!-- No Sabbatical State -->
        <div id="noSabbaticalState" class="hidden text-center py-20">
            <svg class="w-16 h-16 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
            <h2 class="text-xl font-semibold text-gray-700 mb-2">No Active Sabbatical</h2>
            <p class="text-gray-500 mb-6">You don't have an approved sabbatical yet.</p>
            <a href="/" class="inline-flex items-center gap-2 bg-fls-orange hover:bg-orange-600 text-white px-6 py-3 rounded-lg font-medium transition">
                Apply for Sabbatical
            </a>
        </div>

        <!-- Sabbatical Content -->
        <div id="sabbaticalContent" class="hidden">
            <!-- Header Card -->
            <div class="bg-white rounded-xl shadow-md p-6 mb-6">
                <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
                    <!-- Employee Info -->
                    <div class="flex items-center gap-4">
                        <div class="w-16 h-16 bg-fls-navy rounded-full flex items-center justify-center text-white text-2xl font-bold" id="avatarInitials">
                            SJ
                        </div>
                        <div>
                            <h2 class="text-xl font-bold text-fls-navy" id="employeeName">Sarah Johnson</h2>
                            <p class="text-gray-600" id="employeeDetails">Lead Teacher, Langston Hughes Academy</p>
                            <p class="text-sm text-gray-500" id="yearsOfService">15 Years of Service</p>
                        </div>
                    </div>
                    <!-- Status Badge -->
                    <div class="flex items-center gap-4">
                        <span id="statusBadge" class="px-4 py-2 rounded-full text-sm font-semibold status-planning">
                            Planning
                        </span>
                    </div>
                </div>

                <!-- Key Dates Row -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-6">
                    <div class="bg-gray-50 rounded-lg p-4 text-center">
                        <div class="text-xs text-gray-500 uppercase tracking-wide">Start Date</div>
                        <div class="text-lg font-bold text-fls-navy mt-1" id="startDate">Jun 1, 2026</div>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-4 text-center">
                        <div class="text-xs text-gray-500 uppercase tracking-wide">End Date</div>
                        <div class="text-lg font-bold text-fls-navy mt-1" id="endDate">Jul 26, 2026</div>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-4 text-center">
                        <div class="text-xs text-gray-500 uppercase tracking-wide">Option</div>
                        <div class="text-lg font-bold text-fls-navy mt-1" id="sabbaticalOption">8 Weeks</div>
                        <div class="text-xs text-gray-500" id="salaryPercent">100% Salary</div>
                    </div>
                    <div class="bg-fls-light-blue rounded-lg p-4 text-center">
                        <div class="text-xs text-gray-500 uppercase tracking-wide">Days Until</div>
                        <div class="text-3xl font-bold text-fls-orange mt-1" id="daysUntil">124</div>
                        <div class="text-xs text-gray-500" id="daysUntilLabel">to start</div>
                    </div>
                </div>

                <!-- Request Date Change Button -->
                <div class="mt-4 flex justify-between items-center">
                    <div class="flex items-center gap-4">
                        <button onclick="openDateChangeModal()" class="text-fls-blue hover:text-fls-navy text-sm font-medium flex items-center gap-1">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                            </svg>
                            Request Date Change
                        </button>
                        <a id="addToCalendarBtn" href="#" target="_blank" class="hidden bg-fls-navy hover:bg-blue-900 text-white px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2 transition">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                            </svg>
                            Add to Google Calendar
                        </a>
                    </div>
                    <!-- Submit Plan Button (only for Tentatively Approved) -->
                    <button id="submitPlanBtn" onclick="submitPlanForApproval()" class="hidden bg-purple-600 hover:bg-purple-700 text-white px-6 py-2 rounded-lg font-medium flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        Submit Plan for Final Approval
                    </button>
                </div>

                <!-- Approver Action Panel (shown to approvers when Plan Submitted) -->
                <div id="approverActionPanel" class="hidden mt-6 bg-purple-50 border-2 border-purple-300 rounded-xl p-6">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-10 h-10 bg-purple-600 rounded-full flex items-center justify-center">
                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <div>
                            <h3 class="font-bold text-purple-900">Your Approval is Needed</h3>
                            <p class="text-sm text-purple-700">Review the plan below and approve or add recommendations</p>
                        </div>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-purple-900 mb-2">Recommendations or Comments (optional)</label>
                        <textarea id="approverComments" rows="2" placeholder="Add any recommendations or comments for the employee..."
                            class="w-full px-4 py-2 border border-purple-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500"></textarea>
                    </div>
                    <div class="flex gap-3">
                        <button onclick="approvePlan()" class="flex-1 bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-semibold flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                            </svg>
                            Approve Plan
                        </button>
                        <button onclick="requestChanges()" class="flex-1 bg-yellow-500 hover:bg-yellow-600 text-white px-6 py-3 rounded-lg font-semibold flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                            </svg>
                            Request Changes
                        </button>
                    </div>
                </div>

                <!-- Resubmit Panel (shown to applicant when changes requested) -->
                <div id="resubmitPanel" class="hidden mt-6 bg-yellow-50 border-2 border-yellow-300 rounded-xl p-6">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-10 h-10 bg-yellow-500 rounded-full flex items-center justify-center">
                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                            </svg>
                        </div>
                        <div>
                            <h3 class="font-bold text-yellow-900">Changes Requested</h3>
                            <p class="text-sm text-yellow-700">Please review the feedback and resubmit your plan</p>
                        </div>
                    </div>
                    <button onclick="resubmitPlan()" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-lg font-semibold flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                        Resubmit Plan for Approval
                    </button>
                </div>

                <!-- Approval Status Section (only for Plan Submitted status) -->
                <div id="approvalStatusSection" class="hidden mt-6 border-t pt-6">
                    <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wide mb-4">Approval Progress</h3>
                    <div id="approvalsList" class="space-y-3">
                        <!-- Approvals will be rendered here -->
                    </div>
                    <!-- Legacy Approve Button (hidden, using new panel instead) -->
                    <div id="approveButtonContainer" class="hidden mt-4 pt-4 border-t">
                        <button onclick="approvePlan()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-medium flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                            </svg>
                            Approve This Plan
                        </button>
                    </div>
                </div>
            </div>

            <!-- Progress Timeline -->
            <div class="bg-white rounded-xl shadow-md p-6 mb-6">
                <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wide mb-4">Sabbatical Journey</h3>
                <div class="relative">
                    <!-- Progress Bar -->
                    <div class="hidden md:block absolute top-4 left-0 right-0 h-1 bg-gray-200 rounded">
                        <div id="progressBar" class="h-1 bg-fls-orange rounded transition-all" style="width: 33%"></div>
                    </div>
                    <!-- Steps -->
                    <div class="grid grid-cols-3 md:grid-cols-6 gap-2 md:gap-4">
                        <div class="text-center" data-step="applied">
                            <div class="w-8 h-8 mx-auto rounded-full bg-green-500 text-white flex items-center justify-center text-sm mb-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                </svg>
                            </div>
                            <div class="text-xs font-medium text-gray-700">Applied</div>
                            <div class="text-xs text-gray-500 hidden md:block" id="appliedDate">Jan 15</div>
                        </div>
                        <div class="text-center" data-step="approved">
                            <div class="w-8 h-8 mx-auto rounded-full bg-green-500 text-white flex items-center justify-center text-sm mb-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                </svg>
                            </div>
                            <div class="text-xs font-medium text-gray-700">Tentative Approval</div>
                            <div class="text-xs text-gray-500 hidden md:block" id="approvedDate">Jan 22</div>
                        </div>
                        <div class="text-center" data-step="planning">
                            <div class="w-8 h-8 mx-auto rounded-full bg-fls-orange text-white flex items-center justify-center text-sm mb-2 ring-4 ring-orange-200">
                                <span class="font-bold">3</span>
                            </div>
                            <div class="text-xs font-medium text-fls-navy">Planning</div>
                            <div class="text-xs text-gray-500 hidden md:block">Current</div>
                        </div>
                        <div class="text-center" data-step="confirmed">
                            <div class="w-8 h-8 mx-auto rounded-full bg-gray-300 text-gray-500 flex items-center justify-center text-sm mb-2">
                                <span class="font-bold">4</span>
                            </div>
                            <div class="text-xs font-medium text-gray-500">Final Approval</div>
                            <div class="text-xs text-gray-400 hidden md:block" id="confirmedDate">-</div>
                        </div>
                        <div class="text-center" data-step="on-sabbatical">
                            <div class="w-8 h-8 mx-auto rounded-full bg-gray-300 text-gray-500 flex items-center justify-center text-sm mb-2">
                                <span class="font-bold">5</span>
                            </div>
                            <div class="text-xs font-medium text-gray-500">On Leave</div>
                            <div class="text-xs text-gray-400 hidden md:block" id="onLeaveDate">Jun 1</div>
                        </div>
                        <div class="text-center" data-step="completed">
                            <div class="w-8 h-8 mx-auto rounded-full bg-gray-300 text-gray-500 flex items-center justify-center text-sm mb-2">
                                <span class="font-bold">6</span>
                            </div>
                            <div class="text-xs font-medium text-gray-500">Complete</div>
                            <div class="text-xs text-gray-400 hidden md:block" id="completeDate">Jul 26</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab Navigation -->
            <div class="bg-white rounded-t-xl shadow-md border-b">
                <div class="flex overflow-x-auto">
                    <button onclick="showTab('checklist')" id="tab-checklist" class="px-4 py-4 text-sm font-medium whitespace-nowrap tab-active">
                        <span class="hidden sm:inline">Planning </span>Checklist
                    </button>
                    <button onclick="showTab('coverage')" id="tab-coverage" class="px-4 py-4 text-sm font-medium whitespace-nowrap tab-inactive">
                        <span class="hidden sm:inline">My </span>Plan
                    </button>
                    <button onclick="showTab('history')" id="tab-history" class="px-4 py-4 text-sm font-medium whitespace-nowrap tab-inactive">
                        History
                    </button>
                </div>
            </div>

            <!-- Tab Content -->
            <div class="bg-white rounded-b-xl shadow-md p-6">
                <!-- Checklist Tab -->
                <div id="content-checklist">
                    <!-- Progress Summary -->
                    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
                        <div>
                            <h3 class="text-lg font-semibold text-fls-navy">Planning Checklist</h3>
                            <p class="text-sm text-gray-500">Track your preparation progress</p>
                        </div>
                        <div class="flex items-center gap-4">
                            <div class="text-right">
                                <div class="text-2xl font-bold text-fls-navy"><span id="completedTasks">12</span>/<span id="totalTasks">47</span></div>
                                <div class="text-xs text-gray-500">Tasks Complete</div>
                            </div>
                            <div class="w-32 h-3 bg-gray-200 rounded-full overflow-hidden">
                                <div id="checklistProgress" class="h-full bg-fls-orange rounded-full transition-all" style="width: 26%"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Filters and Actions -->
                    <div class="flex flex-wrap gap-2 mb-4 items-center justify-between">
                        <div class="flex flex-wrap gap-2 items-center">
                            <select id="phaseFilter" onchange="filterChecklist()" class="px-3 py-2 border rounded-lg text-sm">
                                <option value="">All Phases</option>
                                <option value="planning">Planning</option>
                                <option value="sabbatical">Sabbatical</option>
                                <option value="return">Return</option>
                            </select>
                            <label class="flex items-center gap-2 text-sm text-gray-600">
                                <input type="checkbox" id="incompleteOnly" onchange="filterChecklist()" class="rounded text-fls-orange">
                                Show incomplete only
                            </label>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="printPlanningGuide()" class="px-3 py-2 text-sm bg-gray-100 hover:bg-gray-200 rounded-lg flex items-center gap-1">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path>
                                </svg>
                                Print Guide
                            </button>
                            <button onclick="exportToSheets()" class="px-3 py-2 text-sm bg-green-100 hover:bg-green-200 text-green-700 rounded-lg flex items-center gap-1">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                Export CSV
                            </button>
                        </div>
                    </div>

                    <!-- Checklist Phases -->
                    <div id="checklistContainer" class="space-y-4">
                        <!-- Phases will be rendered by JavaScript -->
                    </div>
                </div>

                <!-- Coverage Tab -->
                <div id="content-coverage" class="hidden">
                    <!-- Plan Documents Section -->
                    <div class="mb-8 pb-6 border-b">
                        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-4">
                            <div>
                                <h3 class="text-lg font-semibold text-fls-navy">Plan Documents</h3>
                                <p class="text-sm text-gray-500">Link to your sabbatical planning documents</p>
                            </div>
                            <button onclick="openPlanLinkModal()" class="bg-fls-navy hover:bg-blue-900 text-white px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path>
                                </svg>
                                Add Link
                            </button>
                        </div>
                        <div id="planLinksContainer" class="space-y-2">
                            <!-- Links will be rendered by JavaScript -->
                        </div>
                        <div id="noPlanLinks" class="text-center py-6 text-gray-500 bg-gray-50 rounded-lg">
                            <svg class="w-8 h-8 mx-auto text-gray-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path>
                            </svg>
                            No plan documents linked yet. Add a link to your Google Doc, OneDrive, or other planning document.
                        </div>
                    </div>

                    <!-- Coverage Plan Section -->
                    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
                        <div>
                            <h3 class="text-lg font-semibold text-fls-navy">Coverage Plan</h3>
                            <p class="text-sm text-gray-500">Who's covering what while you're away</p>
                        </div>
                        <button onclick="openAddCoverageModal()" class="bg-fls-orange hover:bg-orange-600 text-white px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                            </svg>
                            Add Responsibility
                        </button>
                    </div>

                    <!-- Coverage Table -->
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="px-4 py-3 text-left font-semibold text-gray-700">Responsibility</th>
                                    <th class="px-4 py-3 text-left font-semibold text-gray-700">Covered By</th>
                                    <th class="px-4 py-3 text-left font-semibold text-gray-700">Status</th>
                                    <th class="px-4 py-3 text-left font-semibold text-gray-700">Notes</th>
                                    <th class="px-4 py-3 text-left font-semibold text-gray-700"></th>
                                </tr>
                            </thead>
                            <tbody id="coverageTable">
                                <!-- Rows will be rendered by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                    <div id="noCoverage" class="hidden text-center py-8 text-gray-500">
                        No coverage assignments yet. Add your first responsibility above.
                    </div>

                    <!-- Coverage Contacts -->
                    <div class="mt-8 pt-6 border-t">
                        <h4 class="font-semibold text-fls-navy mb-4">Coverage Contacts</h4>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4" id="coverageContacts">
                            <!-- Contacts will be rendered by JavaScript -->
                        </div>
                    </div>
                </div>

                <!-- History Tab -->
                <div id="content-history" class="hidden">
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold text-fls-navy">Activity History</h3>
                        <p class="text-sm text-gray-500">All updates and changes to your sabbatical</p>
                    </div>

                    <div id="historyList" class="space-y-3">
                        <!-- History items will be rendered by JavaScript -->
                    </div>
                    <div id="noHistory" class="hidden text-center py-8 text-gray-500">
                        No activity yet.
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Date Change Modal -->
    <div id="dateChangeModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl max-w-lg w-full">
            <div class="border-b px-6 py-4 flex justify-between items-center">
                <h2 class="text-lg font-bold text-fls-navy">Request Date Change</h2>
                <button onclick="closeDateChangeModal()" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="p-6">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Current Dates</label>
                    <p class="text-gray-600"><span id="currentStartDate">Jun 1, 2026</span> - <span id="currentEndDate">Jul 26, 2026</span></p>
                </div>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">New Start Date</label>
                        <input type="date" id="newStartDate" class="w-full px-4 py-2 border rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">New End Date</label>
                        <input type="date" id="newEndDate" class="w-full px-4 py-2 border rounded-lg">
                    </div>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Reason for Change</label>
                    <textarea id="dateChangeReason" rows="3" placeholder="Please explain why you need to change your dates..."
                        class="w-full px-4 py-2 border rounded-lg"></textarea>
                </div>
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 mb-4">
                    <p class="text-sm text-yellow-800">
                        <strong>Note:</strong> Date changes require approval from your Manager and Talent. HR, Benefits, and Payroll will be notified of approved changes.
                    </p>
                </div>
                <div class="flex justify-end gap-3">
                    <button onclick="closeDateChangeModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800">Cancel</button>
                    <button id="submitDateChangeBtn" onclick="submitDateChange()" class="bg-fls-orange hover:bg-orange-600 text-white px-6 py-2 rounded-lg font-medium disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2">
                        <span id="submitDateChangeText">Submit Request</span>
                        <svg id="submitDateChangeSpinner" class="hidden w-5 h-5 animate-spin" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Notes Modal -->
    <div id="notesModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl max-w-lg w-full max-h-[80vh] overflow-hidden flex flex-col">
            <div class="border-b px-6 py-4 flex justify-between items-center">
                <h2 class="text-lg font-bold text-fls-navy" id="notesModalTitle">Task Notes</h2>
                <button onclick="closeNotesModal()" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="p-6 overflow-y-auto flex-1">
                <div id="existingNotes" class="space-y-3 mb-4">
                    <!-- Existing notes will be rendered here -->
                </div>
                <div class="border-t pt-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Add Note</label>
                    <textarea id="newNoteText" rows="3" placeholder="Add a note..."
                        class="w-full px-4 py-2 border rounded-lg"></textarea>
                </div>
            </div>
            <div class="border-t px-6 py-4 flex justify-end gap-3">
                <button onclick="closeNotesModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800">Cancel</button>
                <button onclick="saveNote()" class="bg-fls-navy hover:bg-blue-900 text-white px-6 py-2 rounded-lg font-medium">
                    Save Note
                </button>
            </div>
        </div>
    </div>

    <!-- Add Coverage Modal -->
    <div id="coverageModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl max-w-lg w-full">
            <div class="border-b px-6 py-4 flex justify-between items-center">
                <h2 id="coverageModalTitle" class="text-lg font-bold text-fls-navy">Add Coverage Assignment</h2>
                <button onclick="closeCoverageModal()" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="p-6">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Responsibility</label>
                        <input type="text" id="coverageResponsibility" placeholder="e.g., 3rd Grade Math Instruction"
                            class="w-full px-4 py-2 border rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Covered By</label>
                        <input type="text" id="coveragePerson" placeholder="Name of person covering"
                            class="w-full px-4 py-2 border rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Their Email</label>
                        <input type="email" id="coverageEmail" placeholder="email@firstlineschools.org"
                            class="w-full px-4 py-2 border rounded-lg">
                    </div>
                    <div id="coverageStatusRow" class="hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                        <select id="coverageStatus" class="w-full px-4 py-2 border rounded-lg">
                            <option value="Pending">Pending</option>
                            <option value="Confirmed">Confirmed</option>
                            <option value="Declined">Declined</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Notes (optional)</label>
                        <textarea id="coverageNotes" rows="2" placeholder="Any additional details..."
                            class="w-full px-4 py-2 border rounded-lg"></textarea>
                    </div>
                </div>
                <div class="flex justify-between mt-6">
                    <button onclick="deleteCoverage()" id="coverageDeleteBtn" class="hidden px-4 py-2 text-red-600 hover:text-red-800 hover:bg-red-50 rounded-lg">
                        Delete
                    </button>
                    <div class="flex gap-3 ml-auto">
                        <button onclick="closeCoverageModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800">Cancel</button>
                        <button onclick="saveCoverage()" id="coverageSaveBtn" class="bg-fls-orange hover:bg-orange-600 text-white px-6 py-2 rounded-lg font-medium">
                            Add Assignment
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Plan Link Modal -->
    <div id="planLinkModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl max-w-lg w-full">
            <div class="border-b px-6 py-4 flex justify-between items-center">
                <h2 id="planLinkModalTitle" class="text-lg font-bold text-fls-navy">Add Plan Document Link</h2>
                <button onclick="closePlanLinkModal()" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="p-6">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Link Title</label>
                    <input type="text" id="planLinkTitle" placeholder="e.g., Sabbatical Planning Doc"
                        class="w-full px-4 py-2 border rounded-lg">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">URL</label>
                    <input type="url" id="planLinkUrl" placeholder="https://docs.google.com/..."
                        class="w-full px-4 py-2 border rounded-lg">
                </div>
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4">
                    <p class="text-sm text-blue-800">
                        <strong>Tip:</strong> You can link to Google Docs, OneDrive, Notion, or any other document sharing service.
                    </p>
                </div>
                <div class="flex justify-end gap-3">
                    <button onclick="closePlanLinkModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800">Cancel</button>
                    <button id="savePlanLinkBtn" onclick="savePlanLink()" class="bg-fls-navy hover:bg-blue-900 text-white px-6 py-2 rounded-lg font-medium disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2">
                        <span id="savePlanLinkText">Save Link</span>
                        <svg id="savePlanLinkSpinner" class="hidden w-5 h-5 animate-spin" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // State
        let sabbaticalData = null;
        let checklistData = [];
        let coverageData = [];
        let planLinksData = [];
        let messagesData = [];
        let historyData = [];
        let editingCoverageId = null;
        let editingPlanLinkId = null;
        let currentUser = null;
        let currentTaskId = null;

        // Checklist template - simplified 3 phases
        const checklistTemplate = [
            {
                phase: 'planning',
                title: 'Planning Phase',
                tasks: [
                    { id: 'p-1', text: 'Application submitted and approved' },
                    { id: 'p-2', text: 'Manager notified and supportive' },
                    { id: 'p-3', text: 'HR, Benefits, and Payroll notified' },
                    { id: 'p-4', text: 'Key stakeholders informed (leadership, partners, team)' },
                    { id: 'p-5', text: 'Coverage plan finalized and approved' },
                    { id: 'p-6', text: 'Coverage person(s) trained and ready' },
                    { id: 'p-7', text: 'Documentation and handoff materials complete' },
                    { id: 'p-8', text: 'Systems access transferred to coverage team' },
                    { id: 'p-9', text: 'Email auto-response and calendar blocks set' },
                    { id: 'p-10', text: 'Final handoff meeting completed' },
                ]
            },
            {
                phase: 'sabbatical',
                title: 'Sabbatical Phase',
                tasks: [
                    { id: 's-1', text: 'Enjoy your time off!!' },
                ]
            },
            {
                phase: 'return',
                title: 'Return Phase',
                tasks: [
                    { id: 'r-1', text: 'Welcome back meeting with manager completed' },
                    { id: 'r-2', text: 'Systems access restored and working' },
                    { id: 'r-3', text: 'Handback from coverage person(s) completed' },
                    { id: 'r-4', text: 'Caught up on key changes and updates' },
                    { id: 'r-5', text: 'HR and Payroll status restored to active' },
                ]
            }
        ];



        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            await checkAuth();
            await loadSabbaticalData();
        });

        // Check authentication
        async function checkAuth() {
            try {
                const response = await fetch('/api/auth/status');
                const data = await response.json();
                if (data.authenticated) {
                    currentUser = data.user;
                    document.getElementById('userName').textContent = data.user.name;

                    // Show approvals link for admins
                    if (data.is_admin) {
                        document.getElementById('approvalsLink').classList.remove('hidden');
                    }
                } else {
                    // Redirect to login (preserve email param if present)
                    const emailParam = getEmailParam();
                    const redirect = emailParam ? `/my-sabbatical?email=${encodeURIComponent(emailParam)}` : '/my-sabbatical';
                    window.location.href = `/login?redirect=${encodeURIComponent(redirect)}`;
                }
            } catch (e) {
                console.error('Auth check failed:', e);
            }
        }

        // Get email parameter from URL (for admin viewing another user)
        function getEmailParam() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('email') || '';
        }

        // Load sabbatical data
        async function loadSabbaticalData() {
            try {
                const emailParam = getEmailParam();
                const url = emailParam ? `/api/my-sabbatical?email=${encodeURIComponent(emailParam)}` : '/api/my-sabbatical';
                console.log('Fetching:', url);
                const response = await fetch(url);
                const data = await response.json();
                console.log('API Response:', data);

                document.getElementById('loadingState').classList.add('hidden');

                if (data.found && data.sabbatical) {
                    console.log('Found sabbatical, rendering...');
                    sabbaticalData = data.sabbatical;
                    checklistData = data.checklist || [];
                    coverageData = data.coverage || [];
                    planLinksData = data.plan_links || [];
                    messagesData = data.messages || [];
                    historyData = data.history || [];

                    // Show admin viewing banner and back button if applicable
                    if (data.viewing_as_admin) {
                        // Show back to admin button in header
                        document.getElementById('backToAdminLink').classList.remove('hidden');

                        // Also show banner below header
                        const banner = document.createElement('div');
                        banner.className = 'bg-purple-600 text-white px-4 py-3 text-center mt-16';
                        banner.innerHTML = `
                            <span class="font-medium">Admin View:</span> Viewing sabbatical planning for
                            <strong>${sabbaticalData.employee_name}</strong>
                        `;
                        document.querySelector('main').insertBefore(banner, document.querySelector('main').firstChild);
                    }

                    renderSabbaticalContent();
                    document.getElementById('sabbaticalContent').classList.remove('hidden');
                } else {
                    console.log('No sabbatical found in response. data.found:', data.found, 'data.sabbatical:', data.sabbatical);
                    document.getElementById('noSabbaticalState').classList.remove('hidden');
                }
            } catch (e) {
                console.error('Failed to load sabbatical:', e);
                document.getElementById('loadingState').classList.add('hidden');
                document.getElementById('noSabbaticalState').classList.remove('hidden');
            }
        }

        // Render sabbatical content
        function renderSabbaticalContent() {
            const s = sabbaticalData;

            // Avatar initials
            const initials = s.employee_name.split(' ').map(n => n[0]).join('').substring(0, 2);
            document.getElementById('avatarInitials').textContent = initials;

            // Employee info
            document.getElementById('employeeName').textContent = s.employee_name;
            document.getElementById('employeeDetails').textContent = s.employee_location || 'FirstLine Schools';
            document.getElementById('yearsOfService').textContent = s.years_of_service ? `${s.years_of_service} Years of Service` : '';

            // Status badge
            const statusBadge = document.getElementById('statusBadge');
            statusBadge.textContent = s.status;
            statusBadge.className = `px-4 py-2 rounded-full text-sm font-semibold status-${s.status.toLowerCase().replace(' ', '-')}`;

            // Dates
            document.getElementById('startDate').textContent = formatDate(s.start_date);
            document.getElementById('endDate').textContent = formatDate(s.end_date);
            document.getElementById('currentStartDate').textContent = formatDate(s.start_date);
            document.getElementById('currentEndDate').textContent = formatDate(s.end_date);

            // Journey timeline dates
            document.getElementById('onLeaveDate').textContent = formatShortDate(s.start_date);
            document.getElementById('completeDate').textContent = formatShortDate(s.end_date);

            // Option
            const optionMatch = s.sabbatical_option.match(/(\d+)\s*Weeks?.*?(\d+)%/i);
            if (optionMatch) {
                document.getElementById('sabbaticalOption').textContent = optionMatch[1] + ' Weeks';
                document.getElementById('salaryPercent').textContent = optionMatch[2] + '% Salary';
            } else {
                document.getElementById('sabbaticalOption').textContent = s.sabbatical_option;
                document.getElementById('salaryPercent').textContent = '';
            }

            // Days until
            if (s.start_date) {
                const start = new Date(s.start_date);
                const today = new Date();
                const diff = Math.ceil((start - today) / (1000 * 60 * 60 * 24));

                if (diff > 0) {
                    document.getElementById('daysUntil').textContent = diff;
                    document.getElementById('daysUntilLabel').textContent = 'days to start';
                } else if (s.end_date) {
                    const end = new Date(s.end_date);
                    const returnDiff = Math.ceil((end - today) / (1000 * 60 * 60 * 24));
                    if (returnDiff > 0) {
                        document.getElementById('daysUntil').textContent = returnDiff;
                        document.getElementById('daysUntilLabel').textContent = 'days remaining';
                    } else {
                        document.getElementById('daysUntil').textContent = '0';
                        document.getElementById('daysUntilLabel').textContent = 'complete!';
                    }
                }
            }

            // Set up Google Calendar link
            if (s.start_date && s.end_date) {
                const calendarBtn = document.getElementById('addToCalendarBtn');
                calendarBtn.href = generateGoogleCalendarUrl(s);
                calendarBtn.classList.remove('hidden');
            }

            // Show/hide submit plan button based on status
            const submitPlanBtn = document.getElementById('submitPlanBtn');
            const approvalStatusSection = document.getElementById('approvalStatusSection');

            if (s.status === 'Tentatively Approved') {
                submitPlanBtn.classList.remove('hidden');
                approvalStatusSection.classList.add('hidden');
            } else if (s.status === 'Plan Submitted') {
                submitPlanBtn.classList.add('hidden');
                approvalStatusSection.classList.remove('hidden');
                loadApprovalStatus();
            } else {
                submitPlanBtn.classList.add('hidden');
                approvalStatusSection.classList.add('hidden');
            }

            // Render all tabs
            renderChecklist();
            renderCoverage();
            renderPlanLinks();
            renderHistory();
        }

        // Render checklist
        function renderChecklist() {
            const container = document.getElementById('checklistContainer');
            const phaseFilter = document.getElementById('phaseFilter').value;
            const incompleteOnly = document.getElementById('incompleteOnly').checked;

            let completedCount = 0;
            let totalCount = 0;

            let html = '';
            checklistTemplate.forEach(phase => {
                if (phaseFilter && phase.phase !== phaseFilter) return;

                const phaseTasks = phase.tasks;
                const phaseCompleted = phaseTasks.filter(t => isTaskComplete(t.id)).length;
                totalCount += phaseTasks.length;
                completedCount += phaseCompleted;
                const isPhaseComplete = phaseCompleted === phaseTasks.length;

                if (incompleteOnly && isPhaseComplete) return;

                // Special styling for sabbatical phase
                const isSabbaticalPhase = phase.phase === 'sabbatical';
                const phaseStyle = isSabbaticalPhase ? 'bg-fls-orange/10 border-fls-orange' : '';

                html += `
                    <div class="border rounded-lg overflow-hidden ${phaseStyle}">
                        <div class="checklist-phase ${isSabbaticalPhase ? 'bg-fls-orange/20' : 'bg-gray-50'} px-4 py-3 flex items-center justify-between" onclick="togglePhase('${phase.phase}')">
                            <div class="flex items-center gap-3">
                                <svg class="w-5 h-5 text-gray-400 transition-transform" id="arrow-${phase.phase}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                                <span class="font-semibold ${isSabbaticalPhase ? 'text-fls-orange' : 'text-fls-navy'}">${phase.title}</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-sm ${isPhaseComplete ? 'text-green-600' : 'text-gray-500'}">${phaseCompleted}/${phaseTasks.length}</span>
                                ${isPhaseComplete ? '<svg class="w-5 h-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>' : ''}
                            </div>
                        </div>
                        <div class="hidden" id="phase-${phase.phase}">
                            <div class="divide-y">
                                ${phaseTasks.map(task => {
                                    const taskData = checklistData.find(c => c.task_id === task.id) || {};
                                    const isComplete = taskData.completed || taskData.employee_done || taskData.manager_done || taskData.hr_done;
                                    if (incompleteOnly && isComplete) return '';
                                    return `
                                        <div class="flex items-center gap-3 px-4 py-3 hover:bg-gray-50">
                                            <input type="checkbox" ${isComplete ? 'checked' : ''}
                                                onchange="updateTaskStatus('${task.id}', 'completed', this.checked)"
                                                class="w-5 h-5 rounded text-fls-orange focus:ring-fls-orange cursor-pointer flex-shrink-0">
                                            <span class="${isComplete ? 'text-gray-400 line-through' : 'text-gray-700'}">${task.text}</span>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;

            // Update progress
            document.getElementById('completedTasks').textContent = completedCount;
            document.getElementById('totalTasks').textContent = totalCount;
            const pct = totalCount > 0 ? Math.round((completedCount / totalCount) * 100) : 0;
            document.getElementById('checklistProgress').style.width = pct + '%';
        }

        function isTaskComplete(taskId) {
            const task = checklistData.find(c => c.task_id === taskId);
            if (!task) return false;
            // Task is complete if completed flag is set (or legacy role flags)
            return task.completed || task.employee_done || task.manager_done || task.hr_done;
        }

        function togglePhase(phase) {
            const content = document.getElementById(`phase-${phase}`);
            const arrow = document.getElementById(`arrow-${phase}`);
            content.classList.toggle('hidden');
            arrow.classList.toggle('rotate-180');
        }

        async function updateTaskStatus(taskId, role, checked) {
            try {
                const response = await fetch(`/api/my-sabbatical/checklist/${taskId}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ role, checked })
                });
                const result = await response.json();
                if (result.success) {
                    // Update local data
                    let task = checklistData.find(c => c.task_id === taskId);
                    if (!task) {
                        task = { task_id: taskId };
                        checklistData.push(task);
                    }
                    if (role === 'completed') {
                        task.completed = checked;
                    } else {
                        task[`${role}_done`] = checked;
                    }
                    renderChecklist();
                }
            } catch (e) {
                console.error('Failed to update task:', e);
            }
        }

        function filterChecklist() {
            renderChecklist();
        }

        // Render coverage
        function renderCoverage() {
            const tbody = document.getElementById('coverageTable');
            const noCoverage = document.getElementById('noCoverage');

            if (coverageData.length > 0) {
                tbody.innerHTML = coverageData.map(c => `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="px-4 py-3 font-medium">${c.responsibility}</td>
                        <td class="px-4 py-3">${c.covered_by}</td>
                        <td class="px-4 py-3">
                            <span class="px-2 py-1 rounded text-xs font-medium ${c.status === 'Confirmed' ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'}">
                                ${c.status || 'Pending'}
                            </span>
                        </td>
                        <td class="px-4 py-3 text-gray-500 text-sm">${c.notes || '-'}</td>
                        <td class="px-4 py-3">
                            <button onclick="editCoverage('${c.id}')" class="text-fls-blue hover:underline text-sm">Edit</button>
                        </td>
                    </tr>
                `).join('');
                noCoverage.classList.add('hidden');
            } else {
                tbody.innerHTML = '';
                noCoverage.classList.remove('hidden');
            }

            // Render contacts
            const contacts = document.getElementById('coverageContacts');
            contacts.innerHTML = `
                <div class="bg-gray-50 rounded-lg p-4">
                    <div class="text-xs text-gray-500 uppercase mb-1">Primary Contact</div>
                    <div class="font-medium">${coverageData[0]?.covered_by || 'Not assigned'}</div>
                    <div class="text-sm text-gray-500">${coverageData[0]?.email || ''}</div>
                </div>
                <div class="bg-gray-50 rounded-lg p-4">
                    <div class="text-xs text-gray-500 uppercase mb-1">Secondary Contact</div>
                    <div class="font-medium">${coverageData[1]?.covered_by || 'Not assigned'}</div>
                    <div class="text-sm text-gray-500">${coverageData[1]?.email || ''}</div>
                </div>
                <div class="bg-gray-50 rounded-lg p-4">
                    <div class="text-xs text-gray-500 uppercase mb-1">Emergency Contact</div>
                    <div class="font-medium">School Principal</div>
                    <div class="text-sm text-gray-500">For urgent matters only</div>
                </div>
            `;
        }

        // Render messages
        function renderMessages() {
            const list = document.getElementById('messagesList');
            const noMessages = document.getElementById('noMessages');

            if (messagesData.length > 0) {
                list.innerHTML = messagesData.map(m => `
                    <div class="border rounded-lg p-4 ${m.unread ? 'bg-blue-50 border-blue-200' : ''}">
                        <div class="flex justify-between items-start mb-2">
                            <span class="font-semibold text-fls-navy">${m.from_name}</span>
                            <span class="text-xs text-gray-500">${formatDateTime(m.sent_at)}</span>
                        </div>
                        <p class="text-gray-700 text-sm">${m.message}</p>
                        <button onclick="replyToMessage('${m.id}')" class="text-fls-blue text-sm mt-2 hover:underline">Reply</button>
                    </div>
                `).join('');
                noMessages.classList.add('hidden');
            } else {
                list.innerHTML = '';
                noMessages.classList.remove('hidden');
            }

            // Update unread badge
            const unread = messagesData.filter(m => m.unread).length;
            const badge = document.getElementById('unreadBadge');
            if (unread > 0) {
                badge.textContent = unread;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }

        // Render history
        function renderHistory() {
            const list = document.getElementById('historyList');
            const noHistory = document.getElementById('noHistory');

            // Filter to major milestones only
            const majorKeywords = ['submitted', 'approved', 'denied', 'plan', 'date change', 'revision', 'status', 'coverage'];
            const majorEvents = historyData.filter(h => {
                const desc = (h.description || '').toLowerCase();
                return majorKeywords.some(kw => desc.includes(kw));
            });

            // Also include sabbatical data milestones
            const milestones = [];
            if (sabbaticalData) {
                if (sabbaticalData.submitted_at) {
                    milestones.push({ timestamp: sabbaticalData.submitted_at, description: 'Application submitted', icon: 'submit' });
                }
                if (sabbaticalData.status === 'Approved' && sabbaticalData.updated_at) {
                    milestones.push({ timestamp: sabbaticalData.updated_at, description: 'Application approved', icon: 'approve' });
                }
            }

            // Combine and sort by date
            const allEvents = [...milestones, ...majorEvents].sort((a, b) =>
                new Date(b.timestamp) - new Date(a.timestamp)
            );

            if (allEvents.length > 0) {
                list.innerHTML = allEvents.map(h => `
                    <div class="flex items-start gap-3 text-sm py-2 border-b last:border-0">
                        <div class="w-24 text-gray-500 flex-shrink-0 font-medium">${formatShortDate(h.timestamp)}</div>
                        <div class="text-gray-700">${h.description}</div>
                    </div>
                `).join('');
                noHistory.classList.add('hidden');
            } else {
                list.innerHTML = '';
                noHistory.classList.remove('hidden');
            }
        }

        // Tab navigation
        function showTab(tab) {
            const tabs = ['checklist', 'coverage', 'history'];
            tabs.forEach(t => {
                document.getElementById(`tab-${t}`).className = t === tab ? 'px-4 py-4 text-sm font-medium whitespace-nowrap tab-active' : 'px-4 py-4 text-sm font-medium whitespace-nowrap tab-inactive';
                document.getElementById(`content-${t}`).classList.toggle('hidden', t !== tab);
            });
        }

        // Print planning guide
        function printPlanningGuide() {
            const printWindow = window.open('', '_blank');
            const employeeName = sabbaticalData?.employee_name || currentUser?.name || 'Employee';
            const startDate = sabbaticalData?.start_date || 'TBD';
            const endDate = sabbaticalData?.end_date || 'TBD';

            let html = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Sabbatical Planning Guide - ${employeeName}</title>
                    <style>
                        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
                        h1 { color: #002f60; border-bottom: 3px solid #e47727; padding-bottom: 10px; }
                        h2 { color: #002f60; margin-top: 30px; border-bottom: 1px solid #ccc; padding-bottom: 5px; }
                        .header-info { background: #f5f5f5; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
                        .header-info p { margin: 5px 0; }
                        ul { margin: 10px 0; list-style: none; padding-left: 0; }
                        li { margin: 12px 0; padding-left: 5px; display: flex; align-items: flex-start; gap: 10px; }
                        .checkbox { display: inline-block; width: 18px; height: 18px; min-width: 18px; border: 2px solid #666; margin-top: 2px; }
                        .checked { background: #22c55e; border-color: #22c55e; }
                        .phase { page-break-inside: avoid; margin-bottom: 25px; }
                        .sabbatical-phase h2 { color: #e47727; }
                        .sabbatical-phase { background: #fff7ed; padding: 15px; border-radius: 8px; }
                        @media print { body { padding: 0; } }
                    </style>
                </head>
                <body>
                    <h1>Sabbatical Planning Checklist</h1>
                    <div class="header-info">
                        <p><strong>Employee:</strong> ${employeeName}</p>
                        <p><strong>Sabbatical Dates:</strong> ${startDate} to ${endDate}</p>
                        <p><strong>Generated:</strong> ${new Date().toLocaleDateString()}</p>
                    </div>
            `;

            checklistTemplate.forEach(phase => {
                const isSabbatical = phase.phase === 'sabbatical';
                html += `
                    <div class="phase ${isSabbatical ? 'sabbatical-phase' : ''}">
                        <h2>${phase.title}</h2>
                        <ul>
                            ${phase.tasks.map(task => {
                                const isComplete = isTaskComplete(task.id);
                                return `<li><span class="checkbox ${isComplete ? 'checked' : ''}"></span><span>${task.text}</span></li>`;
                            }).join('')}
                        </ul>
                    </div>
                `;
            });

            html += `
                </body>
                </html>
            `;

            printWindow.document.write(html);
            printWindow.document.close();
            printWindow.print();
        }

        // Export to CSV (for Google Sheets)
        function exportToSheets() {
            const employeeName = sabbaticalData?.employee_name || currentUser?.name || 'Employee';
            const startDate = sabbaticalData?.start_date || 'TBD';
            const endDate = sabbaticalData?.end_date || 'TBD';

            let csv = 'Phase,Task,Completed\n';

            // Add checklist items matching the app
            checklistTemplate.forEach(phase => {
                phase.tasks.forEach(task => {
                    const isComplete = isTaskComplete(task.id) ? 'Yes' : '';
                    csv += `"${phase.title}","${task.text.replace(/"/g, '""')}","${isComplete}"\n`;
                });
            });

            // Download the CSV
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `sabbatical_checklist_${employeeName.replace(/\s+/g, '_')}.csv`;
            link.click();
        }

        // Modal functions
        function openDateChangeModal() {
            document.getElementById('dateChangeModal').classList.remove('hidden');
            if (sabbaticalData.start_date) {
                document.getElementById('newStartDate').value = sabbaticalData.start_date;
            }
            if (sabbaticalData.end_date) {
                document.getElementById('newEndDate').value = sabbaticalData.end_date;
            }
        }

        function closeDateChangeModal() {
            document.getElementById('dateChangeModal').classList.add('hidden');
        }

        async function submitDateChange() {
            const newStart = document.getElementById('newStartDate').value;
            const newEnd = document.getElementById('newEndDate').value;
            const reason = document.getElementById('dateChangeReason').value;

            if (!newStart || !newEnd || !reason) {
                alert('Please fill in all fields');
                return;
            }

            // Disable button and show spinner
            const btn = document.getElementById('submitDateChangeBtn');
            const text = document.getElementById('submitDateChangeText');
            const spinner = document.getElementById('submitDateChangeSpinner');
            btn.disabled = true;
            text.textContent = 'Submitting...';
            spinner.classList.remove('hidden');

            try {
                const response = await fetch('/api/my-sabbatical/date-change', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        new_start_date: newStart,
                        new_end_date: newEnd,
                        reason: reason
                    })
                });
                const result = await response.json();
                if (result.success) {
                    alert('Date change request submitted! Your manager and Talent team will be notified.');
                    closeDateChangeModal();
                } else {
                    alert(result.error || 'Failed to submit request');
                }
            } catch (e) {
                console.error('Failed to submit date change:', e);
                alert('Failed to submit request');
            } finally {
                // Re-enable button
                btn.disabled = false;
                text.textContent = 'Submit Request';
                spinner.classList.add('hidden');
            }
        }

        function openNotesModal(taskId, taskText) {
            currentTaskId = taskId;
            document.getElementById('notesModalTitle').textContent = taskText;

            const task = checklistData.find(c => c.task_id === taskId);
            const notes = task?.notes || [];

            const existingNotes = document.getElementById('existingNotes');
            if (notes.length > 0) {
                existingNotes.innerHTML = notes.map(n => `
                    <div class="bg-gray-50 rounded-lg p-3">
                        <div class="flex justify-between items-start mb-1">
                            <span class="font-medium text-sm">${n.author}</span>
                            <span class="text-xs text-gray-500">${formatDateTime(n.timestamp)}</span>
                        </div>
                        <p class="text-sm text-gray-700">${n.text}</p>
                    </div>
                `).join('');
            } else {
                existingNotes.innerHTML = '<p class="text-gray-500 text-sm">No notes yet.</p>';
            }

            document.getElementById('newNoteText').value = '';
            document.getElementById('notesModal').classList.remove('hidden');
        }

        function closeNotesModal() {
            document.getElementById('notesModal').classList.add('hidden');
            currentTaskId = null;
        }

        async function saveNote() {
            const noteText = document.getElementById('newNoteText').value.trim();
            if (!noteText) {
                alert('Please enter a note');
                return;
            }

            try {
                const response = await fetch(`/api/my-sabbatical/checklist/${currentTaskId}/notes`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: noteText })
                });
                const result = await response.json();
                if (result.success) {
                    // Update local data
                    let task = checklistData.find(c => c.task_id === currentTaskId);
                    if (!task) {
                        task = { task_id: currentTaskId, notes: [] };
                        checklistData.push(task);
                    }
                    if (!task.notes) task.notes = [];
                    task.notes.push({
                        author: currentUser.name,
                        text: noteText,
                        timestamp: new Date().toISOString()
                    });
                    closeNotesModal();
                    renderChecklist();
                } else {
                    alert(result.error || 'Failed to save note');
                }
            } catch (e) {
                console.error('Failed to save note:', e);
                alert('Failed to save note');
            }
        }

        function openAddCoverageModal() {
            editingCoverageId = null;
            document.getElementById('coverageModalTitle').textContent = 'Add Coverage Assignment';
            document.getElementById('coverageSaveBtn').textContent = 'Add Assignment';
            document.getElementById('coverageDeleteBtn').classList.add('hidden');
            document.getElementById('coverageResponsibility').value = '';
            document.getElementById('coveragePerson').value = '';
            document.getElementById('coverageEmail').value = '';
            document.getElementById('coverageStatus').value = 'Pending';
            document.getElementById('coverageNotes').value = '';
            document.getElementById('coverageStatusRow').classList.add('hidden');
            document.getElementById('coverageModal').classList.remove('hidden');
        }

        function editCoverage(coverageId) {
            const coverage = coverageData.find(c => c.id === coverageId);
            if (!coverage) return;

            editingCoverageId = coverageId;
            document.getElementById('coverageModalTitle').textContent = 'Edit Coverage Assignment';
            document.getElementById('coverageSaveBtn').textContent = 'Save Changes';
            document.getElementById('coverageDeleteBtn').classList.remove('hidden');
            document.getElementById('coverageResponsibility').value = coverage.responsibility || '';
            document.getElementById('coveragePerson').value = coverage.covered_by || '';
            document.getElementById('coverageEmail').value = coverage.email || '';
            document.getElementById('coverageStatus').value = coverage.status || 'Pending';
            document.getElementById('coverageNotes').value = coverage.notes || '';
            document.getElementById('coverageStatusRow').classList.remove('hidden');
            document.getElementById('coverageModal').classList.remove('hidden');
        }

        function closeCoverageModal() {
            editingCoverageId = null;
            document.getElementById('coverageModal').classList.add('hidden');
        }

        async function deleteCoverage() {
            if (!editingCoverageId) return;

            if (!confirm('Are you sure you want to delete this coverage assignment?')) {
                return;
            }

            try {
                const response = await fetch(`/api/my-sabbatical/coverage/${editingCoverageId}`, {
                    method: 'DELETE'
                });
                const result = await response.json();

                if (result.success) {
                    // Remove from local data
                    coverageData = coverageData.filter(c => c.id !== editingCoverageId);
                    closeCoverageModal();
                    renderCoverage();
                } else {
                    alert(result.error || 'Failed to delete coverage');
                }
            } catch (e) {
                console.error('Failed to delete coverage:', e);
                alert('Failed to delete coverage');
            }
        }

        async function saveCoverage() {
            const responsibility = document.getElementById('coverageResponsibility').value.trim();
            const person = document.getElementById('coveragePerson').value.trim();
            const email = document.getElementById('coverageEmail').value.trim();
            const status = document.getElementById('coverageStatus').value;
            const notes = document.getElementById('coverageNotes').value.trim();

            if (!responsibility || !person) {
                alert('Please fill in responsibility and covered by');
                return;
            }

            try {
                if (editingCoverageId) {
                    // Update existing coverage
                    const response = await fetch(`/api/my-sabbatical/coverage/${editingCoverageId}`, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            responsibility,
                            covered_by: person,
                            email,
                            status,
                            notes
                        })
                    });
                    const result = await response.json();
                    if (result.success) {
                        // Update local data
                        const idx = coverageData.findIndex(c => c.id === editingCoverageId);
                        if (idx >= 0) {
                            coverageData[idx] = {
                                ...coverageData[idx],
                                responsibility,
                                covered_by: person,
                                email,
                                status,
                                notes
                            };
                        }
                        closeCoverageModal();
                        renderCoverage();
                    } else {
                        alert(result.error || 'Failed to update coverage');
                    }
                } else {
                    // Add new coverage
                    const response = await fetch('/api/my-sabbatical/coverage', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            responsibility,
                            covered_by: person,
                            email,
                            notes
                        })
                    });
                    const result = await response.json();
                    if (result.success) {
                        coverageData.push({
                            id: result.id,
                            responsibility,
                            covered_by: person,
                            email,
                            notes,
                            status: 'Pending'
                        });
                        closeCoverageModal();
                        renderCoverage();
                    } else {
                        alert(result.error || 'Failed to save coverage');
                    }
                }
            } catch (e) {
                console.error('Failed to save coverage:', e);
                alert('Failed to save coverage');
            }
        }

        // Plan Link Modal functions
        function openPlanLinkModal(linkId = null) {
            editingPlanLinkId = linkId;
            if (linkId) {
                const link = planLinksData.find(l => l.id === linkId);
                if (link) {
                    document.getElementById('planLinkTitle').value = link.title;
                    document.getElementById('planLinkUrl').value = link.url;
                    document.getElementById('planLinkModalTitle').textContent = 'Edit Plan Document Link';
                    document.getElementById('savePlanLinkText').textContent = 'Update Link';
                }
            } else {
                document.getElementById('planLinkTitle').value = '';
                document.getElementById('planLinkUrl').value = '';
                document.getElementById('planLinkModalTitle').textContent = 'Add Plan Document Link';
                document.getElementById('savePlanLinkText').textContent = 'Save Link';
            }
            document.getElementById('planLinkModal').classList.remove('hidden');
        }

        function closePlanLinkModal() {
            editingPlanLinkId = null;
            document.getElementById('planLinkModal').classList.add('hidden');
        }

        async function savePlanLink() {
            const title = document.getElementById('planLinkTitle').value.trim();
            const url = document.getElementById('planLinkUrl').value.trim();

            if (!title || !url) {
                alert('Please enter both a title and URL');
                return;
            }

            // Basic URL validation
            try {
                new URL(url);
            } catch {
                alert('Please enter a valid URL');
                return;
            }

            // Disable button and show spinner
            const btn = document.getElementById('savePlanLinkBtn');
            const btnText = document.getElementById('savePlanLinkText');
            const btnSpinner = document.getElementById('savePlanLinkSpinner');
            btn.disabled = true;
            btnText.textContent = editingPlanLinkId ? 'Updating...' : 'Saving...';
            btnSpinner.classList.remove('hidden');

            try {
                if (editingPlanLinkId) {
                    // Update existing link
                    const response = await fetch(`/api/my-sabbatical/plan-links/${editingPlanLinkId}`, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ title, url })
                    });
                    const result = await response.json();
                    if (result.success) {
                        const idx = planLinksData.findIndex(l => l.id === editingPlanLinkId);
                        if (idx >= 0) {
                            planLinksData[idx] = { ...planLinksData[idx], title, url };
                        }
                        closePlanLinkModal();
                        renderPlanLinks();
                    } else {
                        alert(result.error || 'Failed to update link');
                    }
                } else {
                    // Add new link
                    const response = await fetch('/api/my-sabbatical/plan-links', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ title, url })
                    });
                    const result = await response.json();
                    if (result.success) {
                        planLinksData.push({
                            id: result.id,
                            title,
                            url,
                            created_at: new Date().toISOString()
                        });
                        closePlanLinkModal();
                        renderPlanLinks();
                    } else {
                        alert(result.error || 'Failed to save link');
                    }
                }
            } catch (e) {
                console.error('Failed to save plan link:', e);
                alert('Failed to save link');
            } finally {
                btn.disabled = false;
                btnText.textContent = editingPlanLinkId ? 'Update Link' : 'Save Link';
                btnSpinner.classList.add('hidden');
            }
        }

        async function deletePlanLink(linkId) {
            if (!confirm('Are you sure you want to remove this link?')) {
                return;
            }

            try {
                const response = await fetch(`/api/my-sabbatical/plan-links/${linkId}`, {
                    method: 'DELETE'
                });
                const result = await response.json();
                if (result.success) {
                    planLinksData = planLinksData.filter(l => l.id !== linkId);
                    renderPlanLinks();
                } else {
                    alert(result.error || 'Failed to delete link');
                }
            } catch (e) {
                console.error('Failed to delete plan link:', e);
                alert('Failed to delete link');
            }
        }

        function renderPlanLinks() {
            const container = document.getElementById('planLinksContainer');
            const noLinks = document.getElementById('noPlanLinks');

            if (!planLinksData || planLinksData.length === 0) {
                container.innerHTML = '';
                noLinks.classList.remove('hidden');
                return;
            }

            noLinks.classList.add('hidden');
            container.innerHTML = planLinksData.map(link => `
                <div class="flex items-center justify-between bg-gray-50 rounded-lg p-3 hover:bg-gray-100">
                    <a href="${link.url}" target="_blank" rel="noopener noreferrer"
                       class="flex items-center gap-3 flex-1 text-fls-blue hover:text-fls-navy">
                        <svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path>
                        </svg>
                        <span class="font-medium">${link.title}</span>
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                        </svg>
                    </a>
                    <div class="flex items-center gap-2 ml-2">
                        <button onclick="openPlanLinkModal('${link.id}')" class="text-gray-400 hover:text-fls-blue p-1" title="Edit">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                            </svg>
                        </button>
                        <button onclick="deletePlanLink('${link.id}')" class="text-gray-400 hover:text-red-500 p-1" title="Remove">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        async function sendMessage() {
            const recipient = document.getElementById('messageRecipient').value;
            const text = document.getElementById('messageText').value.trim();

            if (!recipient || !text) {
                alert('Please select a recipient and enter a message');
                return;
            }

            try {
                const response = await fetch('/api/my-sabbatical/messages', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ recipient, message: text })
                });
                const result = await response.json();
                if (result.success) {
                    alert('Message sent!');
                    document.getElementById('messageRecipient').value = '';
                    document.getElementById('messageText').value = '';
                    // Reload messages
                    await loadSabbaticalData();
                } else {
                    alert(result.error || 'Failed to send message');
                }
            } catch (e) {
                console.error('Failed to send message:', e);
                alert('Failed to send message');
            }
        }

        // Utility functions
        function formatDate(dateStr) {
            if (!dateStr) return 'TBD';
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        function formatDateTime(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) + ' ' +
                   date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
        }

        function formatShortDate(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        // Generate Google Calendar URL for a sabbatical
        function generateGoogleCalendarUrl(s) {
            if (!s.start_date || !s.end_date) return '#';

            // Format dates for Google Calendar (YYYYMMDD format, all-day event)
            const startDate = s.start_date.replace(/-/g, '');
            // End date needs to be the day AFTER for all-day events in Google Calendar
            const endDateObj = new Date(s.end_date);
            endDateObj.setDate(endDateObj.getDate() + 1);
            const endDate = endDateObj.toISOString().split('T')[0].replace(/-/g, '');

            const title = encodeURIComponent(`Sabbatical: ${s.employee_name}`);
            const details = encodeURIComponent(
                `Employee: ${s.employee_name}\n` +
                `Email: ${s.employee_email}\n` +
                `Location: ${s.employee_location || 'Not specified'}`
            );
            const location = encodeURIComponent(s.employee_location || 'FirstLine Schools');

            return `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${title}&dates=${startDate}/${endDate}&details=${details}&location=${location}`;
        }

        // Submit plan for final approval
        async function submitPlanForApproval() {
            if (!confirm('Are you sure you want to submit your plan for final approval? This will notify your manager chain, Talent, and HR for sign-off.')) {
                return;
            }

            try {
                const response = await fetch('/api/my-sabbatical/submit-plan', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const result = await response.json();

                if (result.success) {
                    alert(`Plan submitted for final approval!\n\nAwaiting approval from ${result.approvers.length} people:\n${result.approvers.map(a => ' ' + a.name + ' (' + a.role + ')').join('\n')}`);
                    // Reload to show new status
                    location.reload();
                } else {
                    alert(result.error || 'Failed to submit plan');
                }
            } catch (e) {
                console.error('Failed to submit plan:', e);
                alert('Failed to submit plan');
            }
        }

        // Load approval status
        async function loadApprovalStatus() {
            if (!sabbaticalData) return;

            try {
                const response = await fetch(`/api/my-sabbatical/approval-status?application_id=${sabbaticalData.application_id}`);
                const result = await response.json();

                const approvalsList = document.getElementById('approvalsList');
                const approvals = result.approvals || [];

                if (approvals.length > 0) {
                    approvalsList.innerHTML = approvals.map(a => `
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                            <div>
                                <div class="font-medium">${a.name}</div>
                                <div class="text-sm text-gray-500">${a.role}</div>
                            </div>
                            <div class="flex items-center gap-2">
                                ${a.status === 'Approved' ? `
                                    <span class="text-green-600 font-medium flex items-center gap-1">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                        </svg>
                                        Approved
                                    </span>
                                    <span class="text-xs text-gray-400">${formatShortDate(a.approved_at)}</span>
                                ` : `
                                    <span class="text-yellow-600 font-medium flex items-center gap-1">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                        Pending
                                    </span>
                                `}
                            </div>
                        </div>
                    `).join('');

                    // Check if current user is an approver with pending status
                    const authData = await fetch('/api/auth/status').then(r => r.json());
                    const userEmail = authData.user?.email?.toLowerCase();
                    const pendingApproval = approvals.find(a => a.email?.toLowerCase() === userEmail && a.status === 'Pending');

                    // Show approver action panel if user is a pending approver
                    if (pendingApproval) {
                        document.getElementById('approverActionPanel').classList.remove('hidden');
                    }

                    // Check if any approver requested changes
                    const changesRequested = approvals.some(a => a.status === 'Changes Requested');
                    const isApplicant = sabbaticalData.employee_email?.toLowerCase() === userEmail;
                    if (changesRequested && isApplicant) {
                        document.getElementById('resubmitPanel').classList.remove('hidden');
                    }
                } else {
                    approvalsList.innerHTML = '<p class="text-gray-500">No approval records found.</p>';
                }
            } catch (e) {
                console.error('Failed to load approval status:', e);
            }
        }

        // Request changes (for approvers)
        async function requestChanges() {
            if (!sabbaticalData) return;

            const comments = document.getElementById('approverComments').value;
            if (!comments.trim()) {
                alert('Please add comments explaining what changes are needed.');
                return;
            }

            try {
                const response = await fetch('/api/my-sabbatical/request-changes', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        application_id: sabbaticalData.application_id,
                        comments: comments
                    })
                });
                const result = await response.json();

                if (result.success) {
                    alert('Changes requested. The employee has been notified.');
                    location.reload();
                } else {
                    alert(result.error || 'Failed to request changes');
                }
            } catch (e) {
                console.error('Failed to request changes:', e);
                alert('Failed to request changes');
            }
        }

        // Resubmit plan (for applicant)
        async function resubmitPlan() {
            if (!confirm('Are you sure you want to resubmit your plan for approval?')) {
                return;
            }

            try {
                const response = await fetch('/api/my-sabbatical/resubmit-plan', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        application_id: sabbaticalData.application_id
                    })
                });
                const result = await response.json();

                if (result.success) {
                    alert('Plan resubmitted for approval!');
                    location.reload();
                } else {
                    alert(result.error || 'Failed to resubmit plan');
                }
            } catch (e) {
                console.error('Failed to resubmit plan:', e);
                alert('Failed to resubmit plan');
            }
        }

        // Approve plan (for approvers)
        async function approvePlan() {
            if (!sabbaticalData) return;

            const comments = document.getElementById('approverComments')?.value || '';

            if (!confirm('Are you sure you want to approve this sabbatical plan?')) {
                return;
            }

            try {
                const response = await fetch('/api/my-sabbatical/approve-plan', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        application_id: sabbaticalData.application_id,
                        comments: comments
                    })
                });
                const result = await response.json();

                if (result.success) {
                    if (result.final_approval) {
                        alert('Final approval granted! All approvers have signed off. The employee and all parties have been notified.');
                    } else {
                        alert(`Approval recorded! (${result.approved}/${result.total} approvals complete)`);
                    }
                    // Reload to show updated status
                    location.reload();
                } else {
                    alert(result.error || 'Failed to approve plan');
                }
            } catch (e) {
                console.error('Failed to approve plan:', e);
                alert('Failed to approve plan');
            }
        }
    </script>
</body>
</html>
